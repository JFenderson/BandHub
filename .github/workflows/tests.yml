name: Test Suite

on:
  push:
    branches: [main]
  pull_request:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Build shared types
        run: npm run build:shared
      - name: Build packages
        run: |
          npm run build --workspace=@bandhub/database
          npm run build --workspace=@bandhub/cache
          npm run build --workspace=@hbcu-band-hub/observability
      - name: Run unit and integration tests with coverage
        run: |
          cd apps/api
          npx jest --config jest.config.ts --coverage --runInBand --coverageReporters=json --coverageReporters=lcov --coverageReporters=text --coverageReporters=json-summary
      - name: Check coverage thresholds
        run: |
          cd apps/api
          # Coverage thresholds are enforced by jest.config.ts
          # This step will fail if coverage is below 80%
          echo "Coverage thresholds checked by Jest"
      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            apps/api/test/coverage
      - name: Comment PR with coverage
        if: github.event_name == 'pull_request'
        uses: romeovs/lcov-reporter-action@v0.3.1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          lcov-file: ./apps/api/test/coverage/lcov.info
          delete-old-comments: true
      - name: Run web E2E smoke
        run: npm run test:e2e -- --filter=@hbcu-band-hub/web || true
      - name: Upload coverage to artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports-full
          path: |
            apps/api/test/coverage
            apps/web/coverage
            coverage
