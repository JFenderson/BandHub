apiVersion: apps/v1
kind: Deployment
metadata:
  name: bandhub-api
  labels:
    app: bandhub-api
spec:
  replicas: 2
  selector:
    matchLabels:
      app: bandhub-api
  template:
    metadata:
      labels:
        app: bandhub-api
    spec:
      containers:
        - name: api
          image: ghcr.io/yourorg/bandhub-api:latest
          ports:
            - containerPort: 3001
          env:
            - name: NODE_ENV
              value: "production"
          readinessProbe:
            httpGet:
              path: /api/health/ready
              port: 3001
            initialDelaySeconds: 10
            periodSeconds: 15
            timeoutSeconds: 5
            failureThreshold: 3
          livenessProbe:
            httpGet:
              path: /api/health/live
              port: 3001
            initialDelaySeconds: 30
            periodSeconds: 20
            timeoutSeconds: 5
            failureThreshold: 5

---
# Service exposing API (including metrics endpoint on /api/metrics)
apiVersion: v1
kind: Service
metadata:
  name: bandhub-api
  labels:
    app: bandhub-api
spec:
  selector:
    app: bandhub-api
  ports:
    - name: http
      port: 80
      targetPort: 3001
    - name: metrics
      port: 9100
      targetPort: 3001

---
# Worker Deployment example (worker runs without HTTP by default â€” we use the metrics port)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: bandhub-worker
  labels:
    app: bandhub-worker
spec:
  replicas: 1
  selector:
    matchLabels:
      app: bandhub-worker
  template:
    metadata:
      labels:
        app: bandhub-worker
    spec:
      containers:
        - name: worker
          image: ghcr.io/yourorg/bandhub-worker:latest
          env:
            - name: ENABLE_WORKER_METRICS
              value: "true"
            - name: WORKER_METRICS_PORT
              value: "9400"
          ports:
            - containerPort: 9400
          # Use the metrics endpoint as a readiness check
          readinessProbe:
            httpGet:
              path: /metrics
              port: 9400
            initialDelaySeconds: 20
            periodSeconds: 20
            timeoutSeconds: 5
            failureThreshold: 3
          # Optional liveness probe (TCP check against metrics port)
          livenessProbe:
            tcpSocket:
              port: 9400
            initialDelaySeconds: 60
            periodSeconds: 30
            timeoutSeconds: 5
            failureThreshold: 6

---
# Service exposing worker metrics (so Prometheus can scrape it via ServiceMonitor)
apiVersion: v1
kind: Service
metadata:
  name: bandhub-worker-metrics
  labels:
    app: bandhub-worker
spec:
  selector:
    app: bandhub-worker
  ports:
    - name: metrics
      port: 9400
      targetPort: 9400

---
# ServiceMonitor (Prometheus Operator) to scrape both API and Worker metrics
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: bandhub-servicemonitor
  namespace: monitoring
  labels:
    release: prometheus
spec:
  selector:
    matchExpressions:
      - key: app
        operator: In
        values: [bandhub-api, bandhub-worker]
  namespaceSelector:
    any: true
  endpoints:
    - port: metrics
      path: /api/metrics
      interval: 15s
      relabelings: []
    - port: metrics
      path: /metrics
      interval: 15s
