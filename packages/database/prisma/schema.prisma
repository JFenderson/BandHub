generator client {
  provider        = "prisma-client-js"
  output          = "../../../node_modules/.prisma/client"
  previewFeatures = ["fullTextSearch"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model BandMetrics {
  id             String         @id
  bandId         String         @unique
  totalViews     Int            @default(0)
  viewsToday     Int            @default(0)
  viewsThisWeek  Int            @default(0)
  viewsThisMonth Int            @default(0)
  totalFavorites Int            @default(0)
  totalFollowers Int            @default(0)
  totalShares    Int            @default(0)
  videoCount     Int            @default(0)
  recentUploads  Int            @default(0)
  avgVideoViews  Float          @default(0)
  trendingScore  Float          @default(0)
  trendDirection TrendDirection @default(STABLE)
  previousRank   Int?
  currentRank    Int?
  lastCalculated DateTime       @default(now())
  updatedAt      DateTime
  bands          bands          @relation(fields: [bandId], references: [id], onDelete: Cascade)

  @@index([bandId])
  @@index([lastCalculated])
  @@index([trendingScore(sort: Desc)])
}

model BandShare {
  id        String   @id
  bandId    String
  platform  String
  userId    String?
  createdAt DateTime @default(now())
  bands     bands    @relation(fields: [bandId], references: [id], onDelete: Cascade)

  @@index([bandId])
  @@index([createdAt])
}

model UserBandFavorite {
  id        String   @id
  userId    String
  bandId    String
  createdAt DateTime @default(now())
  bands     bands    @relation(fields: [bandId], references: [id], onDelete: Cascade)

  @@unique([userId, bandId])
  @@index([bandId])
  @@index([createdAt])
  @@index([userId])
}

model admin_password_reset_tokens {
  id            String      @id
  token         String      @unique
  admin_user_id String
  expires_at    DateTime
  used          Boolean     @default(false)
  created_at    DateTime    @default(now())
  admin_users   admin_users @relation(fields: [admin_user_id], references: [id], onDelete: Cascade)

  @@index([admin_user_id])
  @@index([expires_at])
  @@index([token])
}

model admin_sessions {
  id                 String           @id
  user_id            String
  ip_address         String?
  user_agent         String?
  device_type        String?
  browser            String?
  os                 String?
  device_fingerprint String?
  country            String?
  region             String?
  city               String?
  latitude           Float?
  longitude          Float?
  is_active          Boolean          @default(true)
  last_activity_at   DateTime         @default(now())
  created_at         DateTime         @default(now())
  expires_at         DateTime
  revoked_at         DateTime?
  revoked_reason     String?
  token_chain_id     String?
  admin_users        admin_users      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  refresh_tokens     refresh_tokens[]

  @@index([is_active])
  @@index([last_activity_at(sort: Desc)])
  @@index([token_chain_id])
  @@index([user_id])
}

model admin_users {
  id                          String                        @id
  email                       String                        @unique
  password_hash               String
  name                        String
  lastLoginAt                 DateTime?
  lastLoginIp                 String?
  failedLoginAttempts         Int                           @default(0)
  lockedUntil                 DateTime?
  updatedAt                   DateTime
  createdAt                   DateTime                      @default(now())
  isActive                    Boolean                       @default(true)
  role                        AdminRole                     @default(ADMIN)
  mfa_backup_codes            String[]                      @default([])
  mfa_enabled                 Boolean                       @default(false)
  mfa_enabled_at              DateTime?
  mfa_secret                  String?
  must_change_password        Boolean                       @default(false)
  password_changed_at         DateTime?
  password_expires_at         DateTime?
  session_version             Int                           @default(0)
  admin_password_reset_tokens admin_password_reset_tokens[]
  admin_sessions              admin_sessions[]
  audit_logs                  audit_logs[]
  magic_links                 magic_links[]
  oauth_accounts              oauth_accounts[]
  password_history            password_history[]
  refresh_tokens              refresh_tokens[]
  security_events             security_events[]
}

model api_keys {
  id                     String    @id
  key                    String    @unique
  name                   String
  description            String?
  created_at             DateTime  @default(now())
  expires_at             DateTime?
  is_active              Boolean   @default(true)
  last_used_at           DateTime?
  updated_at             DateTime
  last_rotated_at        DateTime?
  rotation_warnings_sent Int       @default(0)
  usage_count            Int       @default(0)

  @@index([expires_at])
  @@index([is_active])
  @@index([key])
}

model audit_logs {
  id          String       @id
  action      String
  entity_type String
  entity_id   String
  changes     Json?
  created_at  DateTime     @default(now())
  user_id     String?
  ip_address  String?
  severity    String       @default("info")
  user_agent  String?
  admin_users admin_users? @relation(fields: [user_id], references: [id])

  @@index([action])
  @@index([created_at(sort: Desc)])
  @@index([entity_type, entity_id])
  @@index([severity])
  @@index([user_id, created_at(sort: Desc)])
  @@index([user_id])
}

model bands {
  id                                    String                 @id
  name                                  String
  slug                                  String                 @unique
  school_name                           String
  city                                  String?
  state                                 String
  conference                            String?
  logo_url                              String?
  banner_url                            String?
  description                           String?
  founded_year                          Int?
  youtube_channel_id                    String?
  youtube_playlist_ids                  String[]
  last_sync_at                          DateTime?
  sync_status                           SyncStatus             @default(PENDING)
  is_active                             Boolean                @default(true)
  is_featured                           Boolean                @default(false)
  created_at                            DateTime               @default(now())
  updated_at                            DateTime
  search_keywords                       String[]               @default([])
  featured_order                        Int?
  featured_since                        DateTime?
  earliest_video_date                   DateTime?
  first_synced_at                       DateTime?
  last_full_sync                        DateTime?
  latest_video_date                     DateTime?
  total_video_count                     Int                    @default(0)
  type                                  BandType               @default(SCHOOL)
  BandMetrics                           BandMetrics?
  BandShare                             BandShare[]
  UserBandFavorite                      UserBandFavorite[]
  favorite_bands                        favorite_bands[]
  featured_band_clicks                  featured_band_clicks[]
  quota_usage_log                       quota_usage_log[]
  sync_jobs                             sync_jobs[]
  videos_videos_band_idTobands          videos[]               @relation("videos_band_idTobands")
  videos_videos_opponent_band_idTobands videos[]               @relation("videos_opponent_band_idTobands")
  youtube_videos                        youtube_videos[]

  @@index([conference])
  @@index([featured_order])
  @@index([is_active, is_featured])
  @@index([is_active, state])
  @@index([is_featured, featured_order])
  @@index([school_name])
  @@index([slug])
  @@index([state, conference])
  @@index([state])
  @@index([type])
  @@index([youtube_channel_id])
}

model categories {
  id              String     @id
  name            String     @unique
  slug            String     @unique
  description     String?
  sort_order      Int        @default(0)
  created_at      DateTime   @default(now())
  updated_at      DateTime
  applicableTypes BandType[] @default([SCHOOL, ALL_STAR])
  videos          videos[]

  @@index([slug])
  @@index([sort_order])
}

model content_creators {
  id               String           @id
  name             String
  youtubeChannelId String           @unique
  channelUrl       String
  description      String?
  logoUrl          String?
  thumbnailUrl     String?
  subscriberCount  Int              @default(0)
  totalVideoCount  Int              @default(0)
  videosInOurDb    Int              @default(0)
  isVerified       Boolean          @default(false)
  isFeatured       Boolean          @default(false)
  qualityScore     Int              @default(0)
  lastSyncedAt     DateTime?
  firstSyncedAt    DateTime?
  lastFullSync     DateTime?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime
  videos           videos[]
  youtube_videos   youtube_videos[]

  @@index([createdAt])
  @@index([isFeatured])
  @@index([isFeatured, qualityScore(sort: Desc)])
  @@index([isVerified])
  @@index([qualityScore])
  @@index([youtubeChannelId])
}

model email_verification_tokens {
  id         String   @id
  token      String   @unique
  user_id    String
  expires_at DateTime
  created_at DateTime @default(now())
  users      users    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([user_id])
}

model event_bands {
  id         String   @id
  event_id   String
  band_id    String
  role       String?
  created_at DateTime @default(now())
  events     events   @relation(fields: [event_id], references: [id], onDelete: Cascade)

  @@unique([event_id, band_id])
  @@index([band_id])
  @@index([event_id])
}

model event_videos {
  id         String   @id
  event_id   String
  video_id   String
  created_at DateTime @default(now())
  events     events   @relation(fields: [event_id], references: [id], onDelete: Cascade)

  @@unique([event_id, video_id])
  @@index([event_id])
  @@index([video_id])
}

model events {
  id           String         @id
  name         String
  slug         String         @unique
  description  String?
  event_type   EventType
  event_date   DateTime
  end_date     DateTime?
  location     String?
  venue        String?
  city         String?
  state        String?
  year         Int
  is_recurring Boolean        @default(false)
  is_active    Boolean        @default(true)
  image_url    String?
  created_at   DateTime       @default(now())
  updated_at   DateTime
  event_bands  event_bands[]
  event_videos event_videos[]

  @@index([event_date])
  @@index([event_type])
  @@index([is_active])
  @@index([is_active, year])
  @@index([slug])
  @@index([year])
}

model favorite_bands {
  id                    String   @id
  user_id               String
  band_id               String
  notifications_enabled Boolean  @default(true)
  created_at            DateTime @default(now())
  bands                 bands    @relation(fields: [band_id], references: [id], onDelete: Cascade)
  users                 users    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, band_id])
  @@index([band_id])
  @@index([user_id])
}

model favorite_videos {
  id         String   @id
  user_id    String
  video_id   String
  notes      String?
  created_at DateTime @default(now())
  users      users    @relation(fields: [user_id], references: [id], onDelete: Cascade)
  videos     videos   @relation(fields: [video_id], references: [id], onDelete: Cascade)

  @@unique([user_id, video_id])
  @@index([user_id])
  @@index([video_id])
}

model featured_band_clicks {
  id         String   @id
  band_id    String
  clicked_at DateTime @default(now())
  session_id String?
  bands      bands    @relation(fields: [band_id], references: [id], onDelete: Cascade)

  @@index([band_id])
  @@index([clicked_at])
}

model jwt_keys {
  id         String    @id
  key_id     String    @unique
  version    Int       @default(1)
  is_active  Boolean   @default(true)
  is_primary Boolean   @default(false)
  created_at DateTime  @default(now())
  expires_at DateTime?
  rotated_at DateTime?

  @@index([is_active])
  @@index([is_primary])
}

model magic_links {
  id          String      @id
  token       String      @unique
  user_id     String
  email       String
  expires_at  DateTime
  used_at     DateTime?
  is_used     Boolean     @default(false)
  ip_address  String?
  user_agent  String?
  created_at  DateTime    @default(now())
  admin_users admin_users @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([expires_at])
  @@index([token])
  @@index([user_id])
}

model notification_preferences {
  id                   String   @id
  user_id              String   @unique
  email_new_video      Boolean  @default(true)
  email_upcoming       Boolean  @default(true)
  email_weekly_digest  Boolean  @default(true)
  in_app_notifications Boolean  @default(true)
  created_at           DateTime @default(now())
  updated_at           DateTime
  users                users    @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model notifications {
  id         String   @id
  user_id    String
  type       String
  title      String
  message    String
  data       Json?
  read       Boolean  @default(false)
  created_at DateTime @default(now())
  users      users    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([created_at])
  @@index([user_id, read])
}

model oauth_accounts {
  id               String      @id
  user_id          String
  provider         String
  provider_user_id String
  email            String?
  display_name     String?
  avatar_url       String?
  access_token     String?
  refresh_token    String?
  token_expires_at DateTime?
  created_at       DateTime    @default(now())
  updated_at       DateTime
  admin_users      admin_users @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([provider, provider_user_id])
  @@index([provider])
  @@index([user_id])
}

model password_history {
  id            String      @id
  user_id       String
  password_hash String
  created_at    DateTime    @default(now())
  admin_users   admin_users @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([created_at(sort: Desc)])
  @@index([user_id])
}

model password_policies {
  id                       String   @id
  name                     String   @default("default")
  min_length               Int      @default(8)
  max_length               Int      @default(128)
  require_uppercase        Boolean  @default(true)
  require_lowercase        Boolean  @default(true)
  require_numbers          Boolean  @default(true)
  require_symbols          Boolean  @default(false)
  expiration_days          Int      @default(90)
  history_count            Int      @default(5)
  max_failed_attempts      Int      @default(5)
  lockout_duration_minutes Int      @default(15)
  is_active                Boolean  @default(true)
  created_at               DateTime @default(now())
  updated_at               DateTime
}

model password_reset_tokens {
  id         String   @id
  token      String   @unique
  user_id    String
  expires_at DateTime
  used       Boolean  @default(false)
  created_at DateTime @default(now())
  users      users    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([user_id])
}

model popular_searches {
  id           String   @id
  query        String   @unique
  searchCount  Int      @default(1)
  lastSearched DateTime @default(now())
  createdAt    DateTime @default(now())

  @@index([lastSearched])
  @@index([searchCount])
}

model quota_alerts {
  id              String          @id
  level           QuotaAlertLevel
  message         String
  current_usage   Int
  timestamp       DateTime        @default(now())
  acknowledged    Boolean         @default(false)
  acknowledged_at DateTime?
  acknowledged_by String?
  created_at      DateTime        @default(now())

  @@index([acknowledged])
  @@index([level, acknowledged])
  @@index([level])
  @@index([timestamp(sort: Desc)])
}

model quota_daily_summary {
  id                  String   @id
  date                DateTime @unique @db.Date
  total_usage         Int
  quota_limit         Int
  percentage_used     Float
  operation_breakdown Json?
  top_consumers       Json?
  cache_hit_rate      Float?
  created_at          DateTime @default(now())
  updated_at          DateTime

  @@index([date(sort: Desc)])
  @@index([percentage_used(sort: Desc)])
}

model quota_usage_log {
  id            String     @id
  operation     String
  cost          Int
  timestamp     DateTime   @default(now())
  band_id       String?
  band_name     String?
  sync_job_id   String?
  success       Boolean    @default(true)
  cache_hit     Boolean    @default(false)
  error_message String?
  metadata      Json?
  created_at    DateTime   @default(now())
  bands         bands?     @relation(fields: [band_id], references: [id])
  sync_jobs     sync_jobs? @relation(fields: [sync_job_id], references: [id])

  @@index([band_id])
  @@index([cache_hit])
  @@index([operation])
  @@index([success])
  @@index([sync_job_id])
  @@index([timestamp(sort: Desc), band_id])
  @@index([timestamp(sort: Desc)])
  @@index([timestamp(sort: Desc), operation])
}

model refresh_tokens {
  id                 String          @id
  token              String          @unique
  userId             String
  expiresAt          DateTime
  createdAt          DateTime        @default(now())
  userAgent          String?
  ipAddress          String?
  isRevoked          Boolean         @default(false)
  revokedAt          DateTime?
  device_fingerprint String?
  replaced_by        String?
  revoked_reason     String?
  session_id         String?
  admin_sessions     admin_sessions? @relation(fields: [session_id], references: [id])
  admin_users        admin_users     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([expiresAt])
  @@index([session_id])
  @@index([token])
  @@index([userId])
}

model search_logs {
  id            String   @id
  query         String
  results_count Int
  filters       Json?
  user_id       String?
  session_id    String?
  created_at    DateTime @default(now())

  @@index([created_at(sort: Desc)])
  @@index([query])
  @@index([user_id])
}

model security_events {
  id          String       @id
  user_id     String?
  event_type  String
  severity    String       @default("info")
  description String?
  metadata    Json?
  ip_address  String?
  user_agent  String?
  country     String?
  region      String?
  city        String?
  latitude    Float?
  longitude   Float?
  created_at  DateTime     @default(now())
  admin_users admin_users? @relation(fields: [user_id], references: [id])

  @@index([created_at(sort: Desc)])
  @@index([event_type])
  @@index([ip_address])
  @@index([severity])
  @@index([user_id])
}

model sync_jobs {
  id                    String            @id
  band_id               String?
  job_type              SyncJobType
  status                SyncJobStatus     @default(QUEUED)
  videos_found          Int               @default(0)
  videos_added          Int               @default(0)
  videos_updated        Int               @default(0)
  errors                String[]          @default([])
  priority              SyncPriority      @default(MEDIUM)
  estimated_quota_cost  Int?
  actual_quota_cost     Int?
  quota_approved        Boolean           @default(false)
  quota_approval_reason String?
  started_at            DateTime?
  completed_at          DateTime?
  created_at            DateTime          @default(now())
  error_message         String?
  max_videos            Int?
  published_after       DateTime?
  published_before      DateTime?
  quota_used            Int               @default(0)
  quota_usage_log       quota_usage_log[]
  bands                 bands?            @relation(fields: [band_id], references: [id])

  @@index([band_id])
  @@index([band_id, status])
  @@index([created_at(sort: Desc)])
  @@index([priority])
  @@index([priority, status])
  @@index([quota_approved])
  @@index([status, created_at(sort: Desc)])
  @@index([status])
}

model user_sessions {
  id             String   @id
  user_id        String
  token          String   @unique
  device_type    String?
  browser        String?
  ip_address     String?
  last_active_at DateTime @default(now())
  created_at     DateTime @default(now())
  expires_at     DateTime
  users          users    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([user_id])
}

model users {
  id                        String                      @id
  email                     String                      @unique
  password_hash             String
  name                      String
  avatar                    String?
  bio                       String?
  email_verified            Boolean                     @default(false)
  preferences               Json                        @default("{}")
  last_seen_at              DateTime?
  created_at                DateTime                    @default(now())
  updated_at                DateTime
  email_verification_tokens email_verification_tokens[]
  favorite_bands            favorite_bands[]
  favorite_videos           favorite_videos[]
  notification_preferences  notification_preferences?
  notifications             notifications[]
  password_reset_tokens     password_reset_tokens[]
  user_sessions             user_sessions[]
  watch_later               watch_later[]

  @@index([email])
}

model videos {
  id                                   String                   @id
  youtube_id                           String                   @unique
  title                                String
  description                          String?
  thumbnail_url                        String
  duration                             Int
  published_at                         DateTime
  view_count                           Int                      @default(0)
  like_count                           Int                      @default(0)
  event_name                           String?
  event_year                           Int?
  tags                                 String[]                 @default([])
  is_hidden                            Boolean                  @default(false)
  hide_reason                          String?
  quality_score                        Int                      @default(0)
  created_at                           DateTime                 @default(now())
  updated_at                           DateTime
  band_id                              String
  opponent_band_id                     String?
  category_id                          String?
  creatorId                            String?
  search_vector                        Unsupported("tsvector")?
  favorite_videos                      favorite_videos[]
  bands_videos_band_idTobands          bands                    @relation("videos_band_idTobands", fields: [band_id], references: [id], onDelete: Cascade)
  categories                           categories?              @relation(fields: [category_id], references: [id])
  content_creators                     content_creators?        @relation(fields: [creatorId], references: [id])
  bands_videos_opponent_band_idTobands bands?                   @relation("videos_opponent_band_idTobands", fields: [opponent_band_id], references: [id])
  watch_later                          watch_later[]

  @@index([band_id, category_id])
  @@index([band_id, category_id, is_hidden])
  @@index([band_id, event_year])
  @@index([band_id])
  @@index([band_id, is_hidden, published_at(sort: Desc)])
  @@index([band_id, view_count(sort: Desc)])
  @@index([category_id])
  @@index([category_id, is_hidden, published_at(sort: Desc)])
  @@index([creatorId])
  @@index([duration])
  @@index([event_year])
  @@index([event_year, is_hidden])
  @@index([is_hidden])
  @@index([is_hidden, published_at(sort: Desc)])
  @@index([opponent_band_id])
  @@index([opponent_band_id, is_hidden])
  @@index([published_at(sort: Desc)])
  @@index([quality_score(sort: Desc)])
  @@index([search_vector], type: Gin)
  @@index([title])
  @@index([view_count(sort: Desc)])
}

model watch_later {
  id         String    @id
  user_id    String
  video_id   String
  watched    Boolean   @default(false)
  watched_at DateTime?
  created_at DateTime  @default(now())
  updated_at DateTime
  users      users     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  videos     videos    @relation(fields: [video_id], references: [id], onDelete: Cascade)

  @@unique([user_id, video_id])
  @@index([user_id])
  @@index([video_id])
}

model youtube_videos {
  id               String            @id
  youtube_id       String            @unique
  title            String
  description      String?
  thumbnail_url    String
  url              String
  duration         Int               @default(0)
  published_at     DateTime
  view_count       Int               @default(0)
  like_count       Int               @default(0)
  channel_id       String
  channel_title    String?
  band_id          String?
  creator_id       String?
  sync_status      SyncStatus        @default(PENDING)
  last_synced_at   DateTime?
  sync_errors      String[]          @default([])
  is_promoted      Boolean           @default(false)
  promoted_at      DateTime?
  quality_score    Int               @default(0)
  created_at       DateTime          @default(now())
  updated_at       DateTime
  bands            bands?            @relation(fields: [band_id], references: [id])
  content_creators content_creators? @relation(fields: [creator_id], references: [id])

  @@index([band_id])
  @@index([band_id, published_at(sort: Desc)])
  @@index([channel_id])
  @@index([channel_id, last_synced_at])
  @@index([channel_id, sync_status])
  @@index([creator_id])
  @@index([creator_id, published_at(sort: Desc)])
  @@index([is_promoted])
  @@index([published_at(sort: Desc)])
  @@index([quality_score(sort: Desc)])
  @@index([sync_status, created_at])
  @@index([sync_status])
  @@index([view_count(sort: Desc)])
}

enum AdminRole {
  SUPER_ADMIN
  ADMIN
  MODERATOR
}

enum BandType {
  SCHOOL
  ALL_STAR
}

enum EventType {
  BAYOU_CLASSIC
  SWAC_CHAMPIONSHIP
  HOMECOMING
  BATTLE_OF_THE_BANDS
  FOOTBALL_GAME
  PARADE
  CONCERT
  COMPETITION
  EXHIBITION
  OTHER
}

enum OAuthProvider {
  GOOGLE
  MICROSOFT
}

enum QuotaAlertLevel {
  INFO
  WARNING
  CRITICAL
  DEPLETED
}

enum SecurityEventType {
  LOGIN_SUCCESS
  LOGIN_FAILED
  LOGOUT
  REFRESH_TOKEN_USED
  REFRESH_REUSE_DETECTED
  MFA_ENABLED
  MFA_DISABLED
  MFA_VERIFIED
  MFA_FAILED
  PASSWORD_CHANGED
  PASSWORD_RESET_REQUESTED
  PASSWORD_RESET_COMPLETED
  MAGIC_LINK_CREATED
  MAGIC_LINK_USED
  OAUTH_LINKED
  OAUTH_UNLINKED
  SESSION_CREATED
  SESSION_REVOKED
  ACCOUNT_LOCKED
  ACCOUNT_UNLOCKED
  SUSPICIOUS_LOGIN
}

enum SyncJobStatus {
  QUEUED
  IN_PROGRESS
  COMPLETED
  FAILED
}

enum SyncJobType {
  FULL_SYNC
  INCREMENTAL_SYNC
  SINGLE_VIDEO
  CHANNEL_SYNC
}

enum SyncPriority {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum SyncStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}

enum TrendDirection {
  UP
  DOWN
  STABLE
  NEW
}
