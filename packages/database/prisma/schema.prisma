generator client {
  provider        = "prisma-client-js"
  output          = "../../../node_modules/.prisma/client"
  previewFeatures = ["fullTextSearch"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model BandMetrics {
  id             String         @id @default(cuid())
  bandId         String         @unique @map("bandId")
  totalViews     Int            @default(0) @map("totalViews")
  viewsToday     Int            @default(0) @map("viewsToday")
  viewsThisWeek  Int            @default(0) @map("viewsThisWeek")
  viewsThisMonth Int            @default(0) @map("viewsThisMonth")
  totalFavorites Int            @default(0) @map("totalFavorites")
  totalFollowers Int            @default(0) @map("totalFollowers")
  totalShares    Int            @default(0) @map("totalShares")
  videoCount     Int            @default(0) @map("videoCount")
  recentUploads  Int            @default(0) @map("recentUploads")
  avgVideoViews  Float          @default(0) @map("avgVideoViews")
  trendingScore  Float          @default(0) @map("trendingScore")
  trendDirection TrendDirection @default(STABLE) @map("trendDirection")
  previousRank   Int?           @map("previousRank")
  currentRank    Int?           @map("currentRank")
  lastCalculated DateTime       @default(now()) @map("lastCalculated")
  updatedAt      DateTime       @updatedAt @map("updatedAt")
  band           Band           @relation(fields: [bandId], references: [id], onDelete: Cascade)

  @@index([bandId])
  @@index([lastCalculated])
  @@index([trendingScore(sort: Desc)])
  @@map("BandMetrics")
}

model BandShare {
  id        String   @id @default(cuid())
  bandId    String   @map("bandId")
  platform  String
  userId    String?  @map("userId")
  createdAt DateTime @default(now()) @map("createdAt")
  band      Band     @relation(fields: [bandId], references: [id], onDelete: Cascade)

  @@index([bandId])
  @@index([createdAt])
  @@map("BandShare")
}

model UserBandFavorite {
  id        String   @id @default(cuid())
  userId    String   @map("userId")
  bandId    String   @map("bandId")
  createdAt DateTime @default(now()) @map("createdAt")
  band      Band     @relation(fields: [bandId], references: [id], onDelete: Cascade)

  @@unique([userId, bandId])
  @@index([bandId])
  @@index([createdAt])
  @@index([userId])
  @@map("UserBandFavorite")
}

model AdminPasswordResetToken {
  id          String     @id @default(cuid())
  token       String     @unique
  adminUserId String     @map("adminUserId")
  expiresAt   DateTime   @map("expireAt")  // Fixed: was expireAt
  used        Boolean    @default(false)
  createdAt   DateTime   @default(now()) @map("createdAt")
  adminUser   AdminUser  @relation(fields: [adminUserId], references: [id], onDelete: Cascade)

  @@index([adminUserId])
  @@index([expiresAt])
  @@index([token])
  @@map("admin_password_reset_tokens")
}

model AdminSession {
  id                 String          @id @default(cuid())
  userId             String          @map("user_id")
  ipAddress          String?         @map("ip_address")
  userAgent          String?         @map("user_agent")
  deviceType         String?         @map("device_type")
  browser            String?
  os                 String?
  deviceFingerprint  String?         @map("device_fingerprint")
  country            String?
  region             String?
  city               String?
  latitude           Float?
  longitude          Float?
  isActive           Boolean         @default(true) @map("is_active")
  lastActivityAt     DateTime        @default(now()) @map("last_activity_at")
  createdAt          DateTime        @default(now()) @map("created_at")
  expiresAt          DateTime        @map("expires_at")
  revokedAt          DateTime?       @map("revoked_at")
  revokedReason      String?         @map("revoked_reason")
  tokenChainId       String?         @map("token_chain_id")
  adminUser          AdminUser       @relation(fields: [userId], references: [id], onDelete: Cascade)
  refreshTokens      RefreshToken[]

  @@index([isActive])
  @@index([lastActivityAt(sort: Desc)])
  @@index([tokenChainId])
  @@index([userId])
  @@map("admin_sessions")
}

model AdminUser {
  id                       String                     @id @default(cuid())
  email                    String                     @unique
  passwordHash             String                     @map("password_hash")
  name                     String
  lastLoginAt              DateTime?                  @map("lastLoginAt")
  lastLoginIp              String?                    @map("lastLoginIp")
  failedLoginAttempts      Int                        @default(0) @map("failedLoginAttempts")
  lockedUntil              DateTime?                  @map("lockedUntil")
  updatedAt                DateTime                   @updatedAt @map("updatedAt")
  createdAt                DateTime                   @default(now()) @map("createdAt")
  isActive                 Boolean                    @default(true) @map("isActive")
  role                     AdminRole                  @default(ADMIN)
  mfaBackupCodes           String[]                   @default([]) @map("mfa_backup_codes")
  mfaEnabled               Boolean                    @default(false) @map("mfa_enabled")
  mfaEnabledAt             DateTime?                  @map("mfa_enabled_at")
  mfaSecret                String?                    @map("mfa_secret")
  mustChangePassword       Boolean                    @default(false) @map("must_change_password")
  passwordChangedAt        DateTime?                  @map("password_changed_at")
  passwordExpiresAt        DateTime?                  @map("password_expires_at")
  sessionVersion           Int                        @default(0) @map("session_version")
  passwordResetTokens      AdminPasswordResetToken[]
  adminSessions            AdminSession[]
  auditLogs                AuditLog[]
  magicLinks               MagicLink[]
  oauthAccounts            OAuthAccount[]
  passwordHistory          PasswordHistory[]
  refreshTokens            RefreshToken[]
  securityEvents           SecurityEvent[]

  @@map("admin_users")
}

model ApiKey {
  id                    String            @id @default(cuid())
  key                   String            @unique
  name                  String
  description           String?
  createdAt             DateTime          @default(now()) @map("created_at")
  expiresAt             DateTime?         @map("expires_at")
  isActive              Boolean           @default(true) @map("is_active")
  lastUsedAt            DateTime?         @map("last_used_at")
  updatedAt             DateTime          @updatedAt @map("updated_at")
  lastRotatedAt         DateTime?         @map("last_rotated_at")
  rotationWarningsSent  Int               @default(0) @map("rotation_warnings_sent")
  usageCount            Int               @default(0) @map("usage_count")
  usageLogs             ApiKeyUsageLog[]

  @@index([expiresAt])
  @@index([isActive])
  @@index([key])
  @@map("api_keys")
}

model ApiKeyUsageLog {
  id              String   @id @default(cuid())
  apiKeyId        String   @map("api_key_id")
  date            DateTime @default(now())
  requestCount    Int      @default(0) @map("request_count")
  endpoint        String?
  method          String?
  avgResponseTime Float?   @map("avg_response_time")
  errorCount      Int      @default(0) @map("error_count")
  metadata        Json?    // Store additional tracking data
  apiKey          ApiKey   @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)

  @@unique([apiKeyId, date], name: "apiKeyId_date")
  @@index([apiKeyId, date(sort: Desc)])
  @@index([date])
  @@map("api_key_usage_logs")
}

model AuditLog {
  id          String     @id @default(cuid())
  action      String
  entityType  String     @map("entity_type")
  entityId    String     @map("entity_id")
  changes     Json?
  createdAt   DateTime   @default(now()) @map("created_at")
  userId      String?    @map("user_id")
  ipAddress   String?    @map("ip_address")
  severity    String     @default("info")
  userAgent   String?    @map("user_agent")
  adminUser   AdminUser? @relation(fields: [userId], references: [id])

  @@index([action])
  @@index([createdAt(sort: Desc)])
  @@index([entityType, entityId])
  @@index([severity])
  @@index([userId, createdAt(sort: Desc)])
  @@index([userId])
  @@map("audit_logs")
}

model Band {
  id                 String              @id @default(cuid())
  name               String
  slug               String              @unique
  schoolName         String              @map("school_name")
  city               String?
  state              String
  bandType           BandType            @default(HBCU) @map("band_type")
  conference         String?
  nickname           String?             @map("nickname")
  logoUrl            String?             @map("logo_url")
  bannerUrl          String?             @map("banner_url")
  description        String?
  foundedYear        Int?                @map("founded_year")
  youtubeChannelId   String?             @map("youtube_channel_id")
  youtubePlaylistIds String[]            @map("youtube_playlist_ids")
  lastSyncAt         DateTime?           @map("last_sync_at")
  syncStatus         SyncStatus          @default(PENDING) @map("sync_status")
  isActive           Boolean             @default(true) @map("is_active")
  isFeatured         Boolean             @default(false) @map("is_featured")
  createdAt          DateTime            @default(now()) @map("created_at")
  updatedAt          DateTime            @updatedAt @map("updated_at")
  searchKeywords     String[]            @default([]) @map("search_keywords")
  featuredOrder      Int?                @map("featured_order")
  featuredSince      DateTime?           @map("featured_since")
  earliestVideoDate  DateTime?           @map("earliest_video_date")
  firstSyncedAt      DateTime?           @map("first_synced_at")
  lastFullSync       DateTime?           @map("last_full_sync")
  latestVideoDate    DateTime?           @map("latest_video_date")
  totalVideoCount    Int                 @default(0) @map("total_video_count")
  primaryColor       String?             @map("primary_color")
  secondaryColor     String?             @map("secondary_color")
  
  // Relations
  metrics                   BandMetrics?
  shares                    BandShare[]
  userFavorites             UserBandFavorite[]
  favoriteBands             FavoriteBand[]
  featuredClicks            FeaturedBandClick[]
  quotaUsageLogs            QuotaUsageLog[]
  syncJobs                  SyncJob[]
  videos                    Video[]             @relation("videos_band_idTobands")
  opponentVideos            Video[]             @relation("videos_opponent_band_idTobands")
  youtubeVideos             YouTubeVideo[]      @relation("youtube_videos_band")
  opponentYoutubeVideos     YouTubeVideo[]      @relation("youtube_videos_opponent")
  reviews                   Review[]
  contentShares             ContentShare[]

  @@index([slug])
  @@index([schoolName])
  @@index([state])
  @@index([conference])
  @@index([bandType])
  @@index([isActive, isFeatured])
  @@index([featuredOrder])
  @@index([youtubeChannelId])
  @@index([state, conference])
  @@index([isActive, state])
  @@index([isFeatured, featuredOrder])
  @@map("bands")
}

model Category {
  id              String     @id @default(cuid())
  name            String     @unique
  slug            String     @unique
  description     String?
  sortOrder       Int        @default(0) @map("sort_order")
  createdAt       DateTime   @default(now()) @map("created_at")
  updatedAt       DateTime   @updatedAt @map("updated_at")
  applicableTypes BandType[] @default([HBCU, ALL_STAR]) @map("applicableTypes")
  videos          Video[]

  @@index([slug])
  @@index([sortOrder])
  @@map("categories")
}

model ContentCreator {
  id               String         @id @default(cuid())
  name             String
  youtubeChannelId String         @unique @map("youtubeChannelId")
  channelUrl       String         @map("channelUrl")
  description      String?
  logoUrl          String?        @map("logoUrl")
  thumbnailUrl     String?        @map("thumbnailUrl")
  subscriberCount  Int            @default(0) @map("subscriberCount")
  totalVideoCount  Int            @default(0) @map("totalVideoCount")
  videosInOurDb    Int            @default(0) @map("videosInOurDb")
  isVerified       Boolean        @default(false) @map("isVerified")
  isFeatured       Boolean        @default(false) @map("isFeatured")
  qualityScore     Int            @default(0) @map("qualityScore")
  lastSyncedAt     DateTime?      @map("lastSyncedAt")
  firstSyncedAt    DateTime?      @map("firstSyncedAt")
  lastFullSync     DateTime?      @map("lastFullSync")
  createdAt        DateTime       @default(now()) @map("createdAt")
  updatedAt        DateTime       @updatedAt @map("updatedAt")
  videos           Video[]
  youtubeVideos    YouTubeVideo[]

  @@index([createdAt])
  @@index([isFeatured])
  @@index([isFeatured, qualityScore(sort: Desc)])
  @@index([isVerified])
  @@index([qualityScore])
  @@index([youtubeChannelId])
  @@map("content_creators")
}

model EmailVerificationToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("email_verification_tokens")
}

model EventBand {
  id        String   @id @default(cuid())
  eventId   String   @map("event_id")
  bandId    String   @map("band_id")
  role      String?
  createdAt DateTime @default(now()) @map("created_at")
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([eventId, bandId])
  @@index([bandId])
  @@index([eventId])
  @@map("event_bands")
}

model EventVideo {
  id        String   @id @default(cuid())
  eventId   String   @map("event_id")
  videoId   String   @map("video_id")
  createdAt DateTime @default(now()) @map("created_at")
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([eventId, videoId])
  @@index([eventId])
  @@index([videoId])
  @@map("event_videos")
}

model Event {
  id          String       @id @default(cuid())
  name        String
  slug        String       @unique
  aliases     String[]     @default([]) 
  description String?
  eventType   EventType    @map("event_type")
  eventDate   DateTime?     @map("event_date")
  endDate     DateTime?    @map("end_date")
  location    String?
  venue       String?
  city        String?
  state       String?
  year        Int?
  isRecurring Boolean      @default(true) @map("is_recurring")
  isActive    Boolean      @default(true) @map("is_active")
  tags        String[]     @default([])  // Flexible tags like ["classic", "rivalry", "parade"]
  imageUrl    String?      @map("image_url")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")
  eventBands  EventBand[]
  eventVideos EventVideo[]

  @@index([eventDate])
  @@index([eventType])
  @@index([isActive])
  @@index([isActive, year])
  @@index([slug])
  @@index([year])
  @@map("events")
}

model FavoriteBand {
  id                    String   @id @default(cuid())
  userId                String   @map("user_id")
  bandId                String   @map("band_id")
  notificationsEnabled  Boolean  @default(true) @map("notifications_enabled")
  createdAt             DateTime @default(now()) @map("created_at")
  band                  Band     @relation(fields: [bandId], references: [id], onDelete: Cascade)
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, bandId])
  @@index([bandId])
  @@index([userId])
  @@map("favorite_bands")
}

model FavoriteVideo {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  videoId   String   @map("video_id")
  notes     String?
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  video     Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([userId, videoId])
  @@index([userId])
  @@index([videoId])
  @@map("favorite_videos")
}

model FeaturedBandClick {
  id        String   @id @default(cuid())
  bandId    String   @map("band_id")
  clickedAt DateTime @default(now()) @map("clicked_at")
  sessionId String?  @map("session_id")
  band      Band     @relation(fields: [bandId], references: [id], onDelete: Cascade)

  @@index([bandId])
  @@index([clickedAt])
  @@map("featured_band_clicks")
}

model JwtKey {
  id        String    @id @default(cuid())
  keyId     String    @unique @map("key_id")
  version   Int       @default(1)
  isActive  Boolean   @default(true) @map("is_active")
  isPrimary Boolean   @default(false) @map("is_primary")
  createdAt DateTime  @default(now()) @map("created_at")
  expiresAt DateTime? @map("expires_at")
  rotatedAt DateTime? @map("rotated_at")

  @@index([isActive])
  @@index([isPrimary])
  @@map("jwt_keys")
}

model MagicLink {
  id         String     @id @default(cuid())
  token      String     @unique
  userId     String     @map("user_id")
  email      String
  expiresAt  DateTime   @map("expires_at")
  usedAt     DateTime?  @map("used_at")
  isUsed     Boolean    @default(false) @map("is_used")
  ipAddress  String?    @map("ip_address")
  userAgent  String?    @map("user_agent")
  createdAt  DateTime   @default(now()) @map("created_at")
  adminUser  AdminUser  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([expiresAt])
  @@index([token])
  @@index([userId])
  @@map("magic_links")
}

model NotificationPreference {
  id                  String   @id @default(cuid())
  userId              String   @unique @map("user_id")
  emailNewVideo       Boolean  @default(true) @map("email_new_video")
  emailUpcoming       Boolean  @default(true) @map("email_upcoming")
  emailWeeklyDigest   Boolean  @default(true) @map("email_weekly_digest")
  inAppNotifications  Boolean  @default(true) @map("in_app_notifications")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_preferences")
}

model Notification {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  type      String
  title     String
  message   String
  data      Json?
  read      Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([userId, read])
  @@map("notifications")
}

model OAuthAccount {
  id              String     @id @default(cuid())
  userId          String     @map("user_id")
  provider        String
  providerUserId  String     @map("provider_user_id")
  email           String?
  displayName     String?    @map("display_name")
  avatarUrl       String?    @map("avatar_url")
  accessToken     String?    @map("access_token")
  refreshToken    String?    @map("refresh_token")
  tokenExpiresAt  DateTime?  @map("token_expires_at")
  createdAt       DateTime   @default(now()) @map("created_at")
  updatedAt       DateTime   @updatedAt @map("updated_at")
  adminUser       AdminUser  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerUserId])
  @@index([provider])
  @@index([userId])
  @@map("oauth_accounts")
}

model PasswordHistory {
  id           String     @id @default(cuid())
  userId       String     @map("user_id")
  passwordHash String     @map("password_hash")
  createdAt    DateTime   @default(now()) @map("created_at")
  adminUser    AdminUser  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt(sort: Desc)])
  @@index([userId])
  @@map("password_history")
}

model PasswordPolicy {
  id                      String   @id @default(cuid())
  name                    String   @default("default")
  minLength               Int      @default(8) @map("min_length")
  maxLength               Int      @default(128) @map("max_length")
  requireUppercase        Boolean  @default(true) @map("require_uppercase")
  requireLowercase        Boolean  @default(true) @map("require_lowercase")
  requireNumbers          Boolean  @default(true) @map("require_numbers")
  requireSymbols          Boolean  @default(false) @map("require_symbols")
  expirationDays          Int      @default(90) @map("expiration_days")
  historyCount            Int      @default(5) @map("history_count")
  maxFailedAttempts       Int      @default(5) @map("max_failed_attempts")
  lockoutDurationMinutes  Int      @default(15) @map("lockout_duration_minutes")
  isActive                Boolean  @default(true) @map("is_active")
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")

  @@map("password_policies")
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  used      Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("password_reset_tokens")
}

model PopularSearch {
  id           String   @id @default(cuid())
  query        String   @unique
  searchCount  Int      @default(1) @map("searchCount")
  lastSearched DateTime @default(now()) @map("lastSearched")
  createdAt    DateTime @default(now()) @map("createdAt")

  @@index([lastSearched])
  @@index([searchCount])
  @@map("popular_searches")
}

model QuotaAlert {
  id             String          @id @default(cuid())
  level          QuotaAlertLevel
  message        String
  currentUsage   Int             @map("current_usage")
  timestamp      DateTime        @default(now())
  acknowledged   Boolean         @default(false)
  acknowledgedAt DateTime?       @map("acknowledged_at")
  acknowledgedBy String?         @map("acknowledged_by")
  createdAt      DateTime        @default(now()) @map("created_at")

  @@index([acknowledged])
  @@index([level, acknowledged])
  @@index([level])
  @@index([timestamp(sort: Desc)])
  @@map("quota_alerts")
}

model QuotaDailySummary {
  id                 String   @id @default(cuid())
  date               DateTime @unique @db.Date
  totalUsage         Int      @map("total_usage")
  quotaLimit         Int      @map("quota_limit")
  percentageUsed     Float    @map("percentage_used")
  operationBreakdown Json?    @map("operation_breakdown")
  topConsumers       Json?    @map("top_consumers")
  cacheHitRate       Float?   @map("cache_hit_rate")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  @@index([date(sort: Desc)])
  @@index([percentageUsed(sort: Desc)])
  @@map("quota_daily_summary")
}

model QuotaUsageLog {
  id           String    @id @default(cuid())
  operation    String
  cost         Int
  timestamp    DateTime  @default(now())
  bandId       String?   @map("band_id")
  bandName     String?   @map("band_name")
  syncJobId    String?   @map("sync_job_id")
  success      Boolean   @default(true)
  cacheHit     Boolean   @default(false) @map("cache_hit")
  errorMessage String?   @map("error_message")
  metadata     Json?
  createdAt    DateTime  @default(now()) @map("created_at")
  band         Band?     @relation(fields: [bandId], references: [id])
  syncJob      SyncJob?  @relation(fields: [syncJobId], references: [id])

  @@index([bandId])
  @@index([cacheHit])
  @@index([operation])
  @@index([success])
  @@index([syncJobId])
  @@index([timestamp(sort: Desc), bandId])
  @@index([timestamp(sort: Desc)])
  @@index([timestamp(sort: Desc), operation])
  @@map("quota_usage_log")
}

model RefreshToken {
  id                String        @id @default(cuid())
  token             String        @unique
  userId            String        @map("userId")
  expiresAt         DateTime      @map("expiresAt")
  createdAt         DateTime      @default(now()) @map("createdAt")
  userAgent         String?       @map("userAgent")
  ipAddress         String?       @map("ipAddress")
  isRevoked         Boolean       @default(false) @map("isRevoked")
  revokedAt         DateTime?     @map("revokedAt")
  deviceFingerprint String?       @map("device_fingerprint")
  replacedBy        String?       @map("replaced_by")
  revokedReason     String?       @map("revoked_reason")
  sessionId         String?       @map("session_id")
  adminSession      AdminSession? @relation(fields: [sessionId], references: [id])
  adminUser         AdminUser     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([expiresAt])
  @@index([sessionId])
  @@index([token])
  @@index([userId])
  @@map("refresh_tokens")
}

model SearchLog {
  id           String   @id @default(cuid())
  query        String
  resultsCount Int      @map("results_count")
  filters      Json?
  userId       String?  @map("user_id")
  sessionId    String?  @map("session_id")
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([createdAt(sort: Desc)])
  @@index([query])
  @@index([userId])
  @@map("search_logs")
}

model SecurityEvent {
  id          String     @id @default(cuid())
  userId      String?    @map("user_id")
  eventType   String     @map("event_type")
  severity    String     @default("info")
  description String?
  metadata    Json?
  ipAddress   String?    @map("ip_address")
  userAgent   String?    @map("user_agent")
  country     String?
  region      String?
  city        String?
  latitude    Float?
  longitude   Float?
  createdAt   DateTime   @default(now()) @map("created_at")
  adminUser   AdminUser? @relation(fields: [userId], references: [id])

  @@index([createdAt(sort: Desc)])
  @@index([eventType])
  @@index([ipAddress])
  @@index([severity])
  @@index([userId])
  @@map("security_events")
}

model SyncJob {
  id                   String           @id @default(cuid())
  bandId               String?          @map("band_id")
  jobType              SyncJobType      @map("job_type")
  status               SyncJobStatus    @default(QUEUED)
  videosFound          Int              @default(0) @map("videos_found")
  videosAdded          Int              @default(0) @map("videos_added")
  videosUpdated        Int              @default(0) @map("videos_updated")
  errors               String[]         @default([])
  priority             SyncPriority     @default(MEDIUM)
  estimatedQuotaCost   Int?             @map("estimated_quota_cost")
  actualQuotaCost      Int?             @map("actual_quota_cost")
  quotaApproved        Boolean          @default(false) @map("quota_approved")
  quotaApprovalReason  String?          @map("quota_approval_reason")
  startedAt            DateTime?        @map("started_at")
  completedAt          DateTime?        @map("completed_at")
  createdAt            DateTime         @default(now()) @map("created_at")
  errorMessage         String?          @map("error_message")
  maxVideos            Int?             @map("max_videos")
  publishedAfter       DateTime?        @map("published_after")
  publishedBefore      DateTime?        @map("published_before")
  quotaUsed            Int              @default(0) @map("quota_used")
  quotaUsageLogs       QuotaUsageLog[]
  band                 Band?            @relation(fields: [bandId], references: [id])

  @@index([bandId])
  @@index([bandId, status])
  @@index([createdAt(sort: Desc)])
  @@index([priority])
  @@index([priority, status])
  @@index([quotaApproved])
  @@index([status, createdAt(sort: Desc)])
  @@index([status])
  @@map("sync_jobs")
}

model UserSession {
  id            String   @id @default(cuid())
  userId        String   @map("user_id")
  token         String   @unique
  deviceType    String?  @map("device_type")
  browser       String?
  ipAddress     String?  @map("ip_address")
  lastActiveAt  DateTime @default(now()) @map("last_active_at")
  createdAt     DateTime @default(now()) @map("created_at")
  expiresAt     DateTime @map("expires_at")
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("user_sessions")
}

model User {
  id                       String                    @id @default(cuid())
  email                    String                    @unique
  passwordHash             String                    @map("password_hash")
  name                     String
  username                 String?                   @unique
  role                     UserRole                  @default(USER)
  avatar                   String?
  bio                      String?
  socialLinks              Json?                     @map("social_links")
  emailVerified            Boolean                   @default(false) @map("email_verified")
  preferences              Json                      @default("{}") 
  lastSeenAt               DateTime?                 @map("last_seen_at")
  createdAt                DateTime                  @default(now()) @map("created_at")
  updatedAt                DateTime                  @updatedAt @map("updated_at")
  emailVerificationTokens  EmailVerificationToken[]
  favoriteBands            FavoriteBand[]
  favoriteVideos           FavoriteVideo[]
  notificationPreferences  NotificationPreference?
  notifications            Notification[]
  passwordResetTokens      PasswordResetToken[]
  userSessions             UserSession[]
  watchLater               WatchLater[]
  playlists                Playlist[]
  comments                 Comment[]
  commentLikes             CommentLike[]
  reviews                  Review[]
  reviewVotes              ReviewVote[]
  followers                UserFollower[]            @relation("UserFollowing")
  following                UserFollower[]            @relation("UserFollowers")
  watchHistory             WatchHistory[]
  contentShares            ContentShare[]

  @@index([email])
  @@index([username])
  @@map("users")
}

model Video {
  id                 String              @id @default(cuid())
  youtubeId          String              @unique @map("youtube_id")
  title              String
  description        String?
  thumbnailUrl       String              @map("thumbnail_url")
  duration           Int
  publishedAt        DateTime            @map("published_at")
  viewCount          Int                 @default(0) @map("view_count")
  likeCount          Int                 @default(0) @map("like_count")
  eventName          String?             @map("event_name")
  eventYear          Int?                @map("event_year")
  tags               String[]            @default([])
  isHidden           Boolean             @default(false) @map("is_hidden")
  hideReason         String?             @map("hide_reason")
  qualityScore       Int                 @default(0) @map("quality_score")
  createdAt          DateTime            @default(now()) @map("created_at")
  updatedAt          DateTime            @updatedAt @map("updated_at")
  bandId             String              @map("band_id")
  opponentBandId     String?             @map("opponent_band_id")
  categoryId         String?             @map("category_id")
  creatorId          String?             @map("creatorId")
  searchVector       Unsupported("tsvector")? @map("search_vector")
  favoriteVideos     FavoriteVideo[]
  band               Band                @relation("videos_band_idTobands", fields: [bandId], references: [id], onDelete: Cascade)
  category           Category?           @relation(fields: [categoryId], references: [id])
  contentCreator     ContentCreator?     @relation(fields: [creatorId], references: [id])
  opponentBand       Band?               @relation("videos_opponent_band_idTobands", fields: [opponentBandId], references: [id])
  watchLater         WatchLater[]
  playlistVideos     PlaylistVideo[]
  comments           Comment[]
  watchHistory       WatchHistory[]
  contentShares      ContentShare[]

  @@index([bandId, categoryId])
  @@index([bandId, categoryId, isHidden])
  @@index([bandId, eventYear])
  @@index([bandId])
  @@index([bandId, isHidden, publishedAt(sort: Desc)])
  @@index([bandId, publishedAt(sort: Desc), isHidden])
  @@index([bandId, viewCount(sort: Desc)])
  @@index([categoryId])
  @@index([categoryId, isHidden, publishedAt(sort: Desc)])
  @@index([categoryId, qualityScore(sort: Desc)])
  @@index([createdAt(sort: Desc)])
  @@index([creatorId])
  @@index([duration])
  @@index([eventYear])
  @@index([eventYear, eventName])
  @@index([eventYear, isHidden])
  @@index([isHidden])
  @@index([isHidden, publishedAt(sort: Desc)])
  @@index([opponentBandId])
  @@index([opponentBandId, isHidden])
  @@index([publishedAt(sort: Desc)])
  @@index([qualityScore(sort: Desc)])
  @@index([searchVector], type: Gin)
  @@index([title])
  @@index([viewCount(sort: Desc)])
  @@map("videos")
}

model WatchLater {
  id        String    @id @default(cuid())
  userId    String    @map("user_id")
  videoId   String    @map("video_id")
  watched   Boolean   @default(false)
  watchedAt DateTime? @map("watched_at")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  video     Video     @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([userId, videoId])
  @@index([userId])
  @@index([videoId])
  @@map("watch_later")
}

model YouTubeVideo {
  id               String            @id @default(cuid())
  youtubeId        String            @unique @map("youtube_id")
  title            String
  description      String?
  thumbnailUrl     String            @map("thumbnail_url")
  url              String
  duration         Int               @default(0)
  publishedAt      DateTime          @map("published_at")
  viewCount        Int               @default(0) @map("view_count")
  likeCount        Int               @default(0) @map("like_count")
  channelId        String            @map("channel_id")
  channelTitle     String?           @map("channel_title")
  bandId           String?           @map("band_id")
  opponentBandId   String?           @map("opponent_band_id")
  creatorId        String?           @map("creator_id")
  syncStatus       SyncStatus        @default(PENDING) @map("sync_status")
  lastSyncedAt     DateTime?         @map("last_synced_at")
  syncErrors       String[]          @default([]) @map("sync_errors")
  isPromoted       Boolean           @default(false) @map("is_promoted")
  promotedAt       DateTime?         @map("promoted_at")
  qualityScore     Int               @default(0) @map("quality_score")
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")
  
  band             Band?             @relation("youtube_videos_band", fields: [bandId], references: [id])
  opponentBand     Band?             @relation("youtube_videos_opponent", fields: [opponentBandId], references: [id])
  contentCreator   ContentCreator?   @relation(fields: [creatorId], references: [id])

  @@index([bandId])
  @@index([opponentBandId])
  @@index([bandId, publishedAt(sort: Desc)])
  @@index([channelId])
  @@index([channelId, lastSyncedAt])
  @@index([channelId, syncStatus])
  @@index([creatorId])
  @@index([creatorId, publishedAt(sort: Desc)])
  @@index([isPromoted])
  @@index([publishedAt(sort: Desc)])
  @@index([qualityScore(sort: Desc)])
  @@index([syncStatus, createdAt])
  @@index([syncStatus])
  @@index([viewCount(sort: Desc)])
  @@map("youtube_videos")
}

model Playlist {
  id             String          @id @default(cuid())
  userId         String          @map("user_id")
  name           String
  description    String?
  coverImageUrl  String?         @map("cover_image_url")
  isPublic       Boolean         @default(true) @map("is_public")
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  playlistVideos PlaylistVideo[]
  contentShares  ContentShare[]

  @@index([userId])
  @@index([isPublic])
  @@index([createdAt])
  @@map("playlists")
}

model PlaylistVideo {
  id         String   @id @default(cuid())
  playlistId String   @map("playlist_id")
  videoId    String   @map("video_id")
  position   Int
  addedAt    DateTime @default(now()) @map("added_at")
  playlist   Playlist @relation(fields: [playlistId], references: [id], onDelete: Cascade)
  video      Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([playlistId, videoId])
  @@index([playlistId, position])
  @@index([videoId])
  @@map("playlist_videos")
}

model Comment {
  id           String    @id @default(cuid())
  videoId      String    @map("video_id")
  userId       String    @map("user_id")
  parentId     String?   @map("parent_id")
  content      String
  likeCount    Int       @default(0) @map("like_count")
  dislikeCount Int       @default(0) @map("dislike_count")
  isEdited     Boolean   @default(false) @map("is_edited")
  isDeleted    Boolean   @default(false) @map("is_deleted")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  video        Video     @relation(fields: [videoId], references: [id], onDelete: Cascade)
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent       Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies      Comment[] @relation("CommentReplies")
  likes        CommentLike[]

  @@index([videoId, createdAt])
  @@index([userId])
  @@index([parentId])
  @@map("comments")
}

model CommentLike {
  id        String   @id @default(cuid())
  commentId String   @map("comment_id")
  userId    String   @map("user_id")
  isLike    Boolean  @map("is_like")
  createdAt DateTime @default(now()) @map("created_at")
  comment   Comment  @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([commentId, userId])
  @@index([commentId])
  @@index([userId])
  @@map("comment_likes")
}

model Review {
  id        String   @id @default(cuid())
  bandId    String   @map("band_id")
  userId    String   @map("user_id")
  rating    Int
  title     String?
  content   String
  helpful   Int      @default(0)
  notHelpful Int     @default(0) @map("not_helpful")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  band      Band     @relation(fields: [bandId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  votes     ReviewVote[]

  @@unique([bandId, userId])
  @@index([bandId, createdAt])
  @@index([userId])
  @@index([rating])
  @@map("reviews")
}

model ReviewVote {
  id        String   @id @default(cuid())
  reviewId  String   @map("review_id")
  userId    String   @map("user_id")
  isHelpful Boolean  @map("is_helpful")
  createdAt DateTime @default(now()) @map("created_at")
  review    Review   @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([reviewId, userId])
  @@index([reviewId])
  @@index([userId])
  @@map("review_votes")
}

model UserFollower {
  id          String   @id @default(cuid())
  followerId  String   @map("follower_id")
  followingId String   @map("following_id")
  createdAt   DateTime @default(now()) @map("created_at")
  follower    User     @relation("UserFollowers", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("UserFollowing", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
  @@map("user_followers")
}

model WatchHistory {
  id             String   @id @default(cuid())
  userId         String   @map("user_id")
  videoId        String   @map("video_id")
  watchedAt      DateTime @default(now()) @map("watched_at")
  watchDuration  Int?     @map("watch_duration")
  completed      Boolean  @default(false)
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  video          Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@index([userId, watchedAt])
  @@index([videoId])
  @@map("watch_history")
}

model ContentShare {
  id         String   @id @default(cuid())
  userId     String?  @map("user_id")
  videoId    String?  @map("video_id")
  bandId     String?  @map("band_id")
  playlistId String?  @map("playlist_id")
  platform   String
  sharedAt   DateTime @default(now()) @map("shared_at")
  user       User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  video      Video?   @relation(fields: [videoId], references: [id], onDelete: Cascade)
  band       Band?    @relation(fields: [bandId], references: [id], onDelete: Cascade)
  playlist   Playlist? @relation(fields: [playlistId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([videoId])
  @@index([bandId])
  @@index([playlistId])
  @@index([sharedAt])
  @@map("content_shares")
}

enum UserRole {
  USER
  MODERATOR
  ADMIN
}

enum AdminRole {
  SUPER_ADMIN
  ADMIN
  MODERATOR
}

enum BandType {
  HBCU
  ALL_STAR
}

enum EventType {
  BATTLE_OF_THE_BANDS    // Pure band competition, no football
  FOOTBALL_GAME          // Football game with bands (classics, rivalries, regular games)
  PARADE                 // Parade performance
  CONCERT                // Concert performance
  SHOWCASE               // Exhibition/clinic/workshop
  CONFERENCE_CHAMPIONSHIP // Conference championship
}

enum OAuthProvider {
  GOOGLE
  MICROSOFT
}

enum QuotaAlertLevel {
  INFO
  WARNING
  CRITICAL
  DEPLETED
}

enum SecurityEventType {
  LOGIN_SUCCESS
  LOGIN_FAILED
  LOGOUT
  REFRESH_TOKEN_USED
  REFRESH_REUSE_DETECTED
  MFA_ENABLED
  MFA_DISABLED
  MFA_VERIFIED
  MFA_FAILED
  PASSWORD_CHANGED
  PASSWORD_RESET_REQUESTED
  PASSWORD_RESET_COMPLETED
  MAGIC_LINK_CREATED
  MAGIC_LINK_USED
  OAUTH_LINKED
  OAUTH_UNLINKED
  SESSION_CREATED
  SESSION_REVOKED
  ACCOUNT_LOCKED
  ACCOUNT_UNLOCKED
  SUSPICIOUS_LOGIN
}

enum SyncJobStatus {
  QUEUED
  IN_PROGRESS
  COMPLETED
  FAILED
}

enum SyncJobType {
  FULL_SYNC
  INCREMENTAL_SYNC
  SINGLE_VIDEO
  CHANNEL_SYNC
}

enum SyncPriority {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum SyncStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}

enum TrendDirection {
  UP
  DOWN
  STABLE
  NEW
}
