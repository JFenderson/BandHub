// Prisma schema for HBCU Band Hub
// Docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearch"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// BAND MODEL
// =============================================================================

model Band {
  id                 String   @id @default(cuid())
  name               String   // "Sonic Boom of the South"
  slug               String   @unique // "sonic-boom-of-the-south"
  schoolName         String   @map("school_name") // "Jackson State University"
  city               String
  state              String
  conference         String? // "SWAC", "MEAC", etc.
  logoUrl            String?  @map("logo_url")
  bannerUrl          String?  @map("banner_url")
  description        String?  @db.Text
  foundedYear        Int?     @map("founded_year")
  
  // YouTube integration
  youtubeChannelId   String?  @map("youtube_channel_id")
  youtubePlaylistIds String[] @map("youtube_playlist_ids")
  
  // Sync tracking
  lastSyncAt         DateTime? @map("last_sync_at")
  syncStatus         SyncStatus @default(PENDING) @map("sync_status")
  
  // Status
  isActive           Boolean  @default(true) @map("is_active")
  isFeatured         Boolean  @default(false) @map("is_featured")
  
  // Timestamps
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  // Relations
  videos             Video[]  @relation("BandVideos")
  opponentVideos     Video[]  @relation("OpponentBandVideos")

  // Indexes
  @@index([slug])
  @@index([schoolName])
  @@index([state])
  @@index([conference])
  @@index([isActive, isFeatured])
  
  @@map("bands")
}

enum SyncStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}

// =============================================================================
// VIDEO MODEL
// =============================================================================

model Video {
  id              String   @id @default(cuid())
  youtubeId       String   @unique @map("youtube_id")
  
  // Basic metadata from YouTube
  title           String
  description     String?  @db.Text
  thumbnailUrl    String   @map("thumbnail_url")
  duration        Int      // Duration in seconds
  publishedAt     DateTime @map("published_at")
  
  // YouTube statistics (updated during sync)
  viewCount       Int      @default(0) @map("view_count")
  likeCount       Int      @default(0) @map("like_count")
  
  // HBCU Band Hub metadata (set by admins)
  eventName       String?  @map("event_name") // "Bayou Classic", "SWAC Championship"
  eventYear       Int?     @map("event_year")
  
  // Searchable content
  tags            String[] @default([])
  
  // Moderation
  isHidden        Boolean  @default(false) @map("is_hidden")
  hideReason      String?  @map("hide_reason")
  
  // Quality/relevance scoring (for sorting)
  qualityScore    Int      @default(0) @map("quality_score")
  
  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  // Relations
  bandId          String   @map("band_id")
  band            Band     @relation("BandVideos", fields: [bandId], references: [id], onDelete: Cascade)
  
  opponentBandId  String?  @map("opponent_band_id")
  opponentBand    Band?    @relation("OpponentBandVideos", fields: [opponentBandId], references: [id], onDelete: SetNull)
  
  categoryId      String?  @map("category_id")
  category        Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  // Indexes for filtering and sorting
  @@index([bandId])
  @@index([opponentBandId])
  @@index([categoryId])
  @@index([eventYear])
  @@index([publishedAt(sort: Desc)])
  @@index([viewCount(sort: Desc)])
  @@index([isHidden])
  @@index([bandId, categoryId])
  @@index([bandId, eventYear])
  
  // Full-text search index
  @@index([title])
  
  @@map("videos")
}

// =============================================================================
// CATEGORY MODEL
// =============================================================================

model Category {
  id          String   @id @default(cuid())
  name        String   @unique // "5th Quarter"
  slug        String   @unique // "5th-quarter"
  description String?  @db.Text
  sortOrder   Int      @default(0) @map("sort_order")
  
  // Timestamps
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  videos      Video[]

  @@index([slug])
  @@index([sortOrder])
  
  @@map("categories")
}

// =============================================================================
// ADMIN USER MODEL (for authentication later)
// =============================================================================

model AdminUser {
  id            String   @id @default(cuid())
  email         String   @unique
  passwordHash  String   @map("password_hash")
  name          String
  role          AdminRole @default(MODERATOR)
  
  isActive      Boolean  @default(true) @map("is_active")
  lastLoginAt   DateTime? @map("last_login_at")
  
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  auditLogs     AuditLog[]

  @@map("admin_users")
}

enum AdminRole {
  SUPER_ADMIN
  ADMIN
  MODERATOR
}

// =============================================================================
// AUDIT LOG MODEL (track admin actions)
// =============================================================================

model AuditLog {
  id          String   @id @default(cuid())
  action      String   // "video.hide", "band.sync", "video.categorize"
  entityType  String   @map("entity_type") // "video", "band"
  entityId    String   @map("entity_id")
  changes     Json?    // { before: {...}, after: {...} }
  
  adminUserId String   @map("admin_user_id")
  adminUser   AdminUser @relation(fields: [adminUserId], references: [id])
  
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([entityType, entityId])
  @@index([adminUserId])
  @@index([createdAt(sort: Desc)])
  
  @@map("audit_logs")
}

// =============================================================================
// SYNC JOB MODEL (track YouTube sync history)
// =============================================================================

model SyncJob {
  id            String      @id @default(cuid())
  bandId        String?     @map("band_id") // null for "sync all" jobs
  jobType       SyncJobType @map("job_type")
  status        SyncJobStatus @default(QUEUED)
  
  // Results
  videosFound   Int         @default(0) @map("videos_found")
  videosAdded   Int         @default(0) @map("videos_added")
  videosUpdated Int         @default(0) @map("videos_updated")
  errors        String[]    @default([])
  
  // Timing
  startedAt     DateTime?   @map("started_at")
  completedAt   DateTime?   @map("completed_at")
  
  createdAt     DateTime    @default(now()) @map("created_at")

  @@index([bandId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  
  @@map("sync_jobs")
}

enum SyncJobType {
  FULL_SYNC
  INCREMENTAL_SYNC
  SINGLE_VIDEO
}

enum SyncJobStatus {
  QUEUED
  IN_PROGRESS
  COMPLETED
  FAILED
}